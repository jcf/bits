#!/usr/bin/env bash
#
# Usage:
#     bin/lint
#
# Runs linters and auto-formats code:
# - Formats code with rustfmt
# - Runs clippy with all warnings as errors

set -euo pipefail

source "$(dirname "$0")/../libexec/common.sh"

info "Running linters..."

info "Formatting code..."
fmt_output=$(cargo fmt --all 2>&1)
fmt_exit_code=$?

if [ $fmt_exit_code -eq 0 ]; then
    success "Code formatted"
elif echo "$fmt_output" | grep -q "unknown print request"; then
    warn "Formatting skipped (rustfmt version issue)"
else
    error "Formatting failed"
    echo "$fmt_output" >&2
    exit 1
fi

info "Running clippy..."
if cargo clippy --all-targets --all-features -- -D warnings; then
  success "Clippy passed"
else
  error "Clippy found issues"
  exit 1
fi

success "All lints passed!"
