#+title: Deployment

* Overview

Production container build for =bits-colo= using Docker and Nix.

**Architecture:**
- Multi-stage build (Nix builder â†’ Debian runtime)
- Axum server on port 8080
- Cloudflare Tunnel for ingress
- Tailscale for management access

* Building

Build the container image:

#+begin_src sh
just image-build
#+end_src

* Registry

Push to GitHub Container Registry:

#+begin_src sh
just image-push
#+end_src

Authentication is automatic via GitHub CLI.

* Deployment

Deploy to production via Tailscale:

#+begin_src sh
just deploy-prod
#+end_src

This will:
1. Pull latest image on server
2. Run database migrations
3. Stop old container
4. Start new container
5. Verify health

* Environment Variables

Set on server (via NixOS configuration or systemd):

| Variable                  | Source                  | Description              |
|---------------------------+-------------------------+--------------------------|
| =DATABASE_URL=            | Terraform output        | Pooled connection URL    |
| =DIRECT_DATABASE_URL=     | Terraform output        | Migration connection URL |
| =PLATFORM_DOMAIN=         | Static                  | bits.page                |
| =MASTER_KEY=              | 1Password               | Encryption key           |
| =POSTMARK_ACCOUNT_TOKEN=  | 1Password               | Email service            |
| =ARGON2_M_COST=           | Static                  | 122880                   |
| =ARGON2_T_COST=           | Static                  | 3                        |
| =ARGON2_P_COST=           | Static                  | 4                        |

* Health Check

Verify container health:

#+begin_src sh
curl http://localhost:8080/metrics
#+end_src

Returns Prometheus metrics (no auth via Tailscale).

* Blue-Green Deployment

Migrations run before container swap:

1. SSH via Tailscale to server
2. Run migrations with =DIRECT_DATABASE_URL=
3. Verify migration success
4. Pull new image
5. Stop old container (=bits-app=)
6. Start new container
7. Health check new container
8. If failure, rollback to previous image

* Rollback

Roll back to previous deployment:

#+begin_src sh
just rollback-prod
#+end_src

This will:
1. Stop current container
2. Start previous container image
3. Verify health
